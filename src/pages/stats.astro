---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Statistiques">
    <div class="stats-container">
        <header class="header">
            <div class="header-title">STATISTIQUES</div>
            <div class="spacer"></div>
        </header>

        <div class="stats-content">
            <!-- R√âSUM√â GLOBAL -->
            <section class="summary-cards">
                <div class="stat-card">
                    <i data-lucide="flame" class="stat-icon"></i>
                    <div class="stat-value" id="totalCalories">0</div>
                    <div class="stat-label">Calories br√ªl√©es</div>
                </div>
                <div class="stat-card">
                    <i data-lucide="zap" class="stat-icon"></i>
                    <div class="stat-value" id="totalXp">0</div>
                    <div class="stat-label">XP Total</div>
                </div>
                <div class="stat-card">
                    <i data-lucide="dumbbell" class="stat-icon"></i>
                    <div class="stat-value" id="totalWorkouts">0</div>
                    <div class="stat-label">Entra√Ænements</div>
                </div>
                <div class="stat-card">
                    <i data-lucide="trophy" class="stat-icon"></i>
                    <div class="stat-value" id="currentStreak">0</div>
                    <div class="stat-label">Jours cons√©cutifs</div>
                </div>
            </section>

            <!-- GRAPHIQUE CALORIES PAR JOUR (7 derniers jours) -->
            <section class="chart-section">
                <h2 class="section-title">Calories - 7 derniers jours</h2>
                <div class="chart-container">
                    <canvas id="caloriesChart"></canvas>
                </div>
            </section>

            <!-- TOP EXERCICES -->
            <section class="top-section">
                <h2 class="section-title">Top Exercices</h2>
                <div id="topExercises" class="top-list"></div>
            </section>

            <!-- HISTORIQUE -->
            <section class="history-section">
                <h2 class="section-title">Historique</h2>
                <div id="historyList" class="history-list"></div>
            </section>
        </div>
    </div>
</Layout>

<script>
    import { getSave } from "../scripts/store.js";
    import { CARDS_DATABASE } from "../data/fitquest.js";

    document.addEventListener("astro:page-load", () => {
        const state = getSave();

        // Calculer les statistiques globales
        const history = state.history || [];

        const totalCalories = history.reduce(
            (sum, entry) => sum + (entry.calories || 0),
            0,
        );
        const totalXp = history.reduce(
            (sum, entry) => sum + (entry.xp || 0),
            0,
        );
        const totalWorkouts = history.length;

        // Calculer le streak (jours cons√©cutifs)
        const streak = calculateStreak(history);

        // Afficher les stats globales
        animateValue("totalCalories", totalCalories);
        animateValue("totalXp", totalXp);
        animateValue("totalWorkouts", totalWorkouts);
        animateValue("currentStreak", streak);

        // Cr√©er le graphique des calories (7 derniers jours)
        createCaloriesChart(history);

        // Afficher le top exercices
        displayTopExercises(history);

        // Afficher l'historique
        displayHistory(history);

        // Initialiser les ic√¥nes Lucide
        if (window["lucide"]) window["lucide"].createIcons();
    });

    // @ts-ignore
    function animateValue(id, end) {
        const obj = document.getElementById(id);
        if (!obj) return;

        const start = 0;
        const duration = 1000;
        let startTimestamp = null;

        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min(
                (timestamp - startTimestamp) / duration,
                1,
            );
            obj.innerHTML = Math.floor(progress * (end - start) + start);
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }

    // @ts-ignore
    function calculateStreak(history) {
        if (history.length === 0) return 0;

        const sortedDates = history
            .map((e) => new Date(e.date).setHours(0, 0, 0, 0))
            .filter((date, index, self) => self.indexOf(date) === index)
            .sort((a, b) => b - a);

        let streak = 0;
        const today = new Date().setHours(0, 0, 0, 0);
        const oneDayMs = 24 * 60 * 60 * 1000;

        // Check if last workout was today or yesterday to keep streak alive
        if (sortedDates[0] !== today && sortedDates[0] !== today - oneDayMs) {
            return 0;
        }

        for (let i = 0; i < sortedDates.length; i++) {
            // If the most recent date is today, we start checking from today (offset 0)
            // If the most recent date is yesterday, we effectively treat it as the start of the streak
            // Logic: consecutive days check
            const current = sortedDates[i];
            const next = sortedDates[i + 1];

            streak++;

            if (!next) break;

            if (current - next > oneDayMs) {
                break;
            }
        }

        return streak;
    }

    // @ts-ignore
    function createCaloriesChart(history) {
        const canvas = document.getElementById("caloriesChart");
        if (!canvas) return;

        // Grouper par jour (7 derniers jours)
        const last7Days = [];
        const today = new Date().setHours(0, 0, 0, 0);
        const oneDayMs = 24 * 60 * 60 * 1000;

        for (let i = 6; i >= 0; i--) {
            const date = today - i * oneDayMs;
            const dayEntries = history.filter(
                (e) => new Date(e.date).setHours(0, 0, 0, 0) === date,
            );
            const calories = dayEntries.reduce(
                (sum, e) => sum + (e.calories || 0),
                0,
            );

            const dayName = new Date(date).toLocaleDateString("fr-FR", {
                weekday: "short",
            });
            last7Days.push({ day: dayName, calories });
        }

        // Dessiner le graphique en barres
        // @ts-ignore
        const ctx = canvas.getContext("2d");
        // Handle high DPI displays
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();

        canvas.width = rect.width * dpr;
        canvas.height = 200 * dpr;

        ctx.scale(dpr, dpr);

        const width = rect.width;
        const height = 200;

        const maxCalories = Math.max(...last7Days.map((d) => d.calories), 100);
        const barWidth = (width - 40) / 7 - 10;

        ctx.clearRect(0, 0, width, height);

        last7Days.forEach((day, i) => {
            const barHeight = (day.calories / maxCalories) * (height - 50);
            const x = i * (barWidth + 10) + 25;
            const y = height - barHeight - 25;

            // Glow effect
            if (day.calories > 0) {
                ctx.shadowBlur = 5;
                ctx.shadowColor = "rgba(59, 130, 246, 0.5)";
            } else {
                ctx.shadowBlur = 0;
            }

            // Barre
            const gradient = ctx.createLinearGradient(0, y, 0, height - 25);
            gradient.addColorStop(0, "#8b5cf6");
            gradient.addColorStop(1, "#fbbf24");

            // Rounded top corners
            ctx.fillStyle = gradient;

            if (day.calories > 0) {
                ctx.beginPath();
                ctx.roundRect(x, y, barWidth, barHeight, [4, 4, 0, 0]);
                ctx.fill();
            } else {
                // Empty state bar
                ctx.fillStyle = "rgba(255, 255, 255, 0.05)";
                ctx.beginPath();
                ctx.roundRect(x, height - 28, barWidth, 3, [4, 4, 4, 4]);
                ctx.fill();
            }

            ctx.shadowBlur = 0;

            // Label jour
            ctx.fillStyle = "#94a3b8";
            ctx.font = "500 11px Inter, sans-serif";
            ctx.textAlign = "center";
            ctx.fillText(day.day.toUpperCase(), x + barWidth / 2, height - 5);

            // Valeur
            if (day.calories > 0) {
                ctx.fillStyle = "#fff";
                ctx.font = "bold 12px Rajdhani";
                ctx.fillText(day.calories, x + barWidth / 2, y - 8);
            }
        });
    }

    // @ts-ignore
    function displayTopExercises(history) {
        const container = document.getElementById("topExercises");
        if (!container) return;

        // Compter les occurrences
        const exerciseCount = {};
        history.forEach((entry) => {
            if (!exerciseCount[entry.name]) {
                exerciseCount[entry.name] = {
                    count: 0,
                    totalValue: 0,
                    unit: entry.unit,
                };
            }
            exerciseCount[entry.name].count++;
            exerciseCount[entry.name].totalValue += entry.value;
        });

        // Trier par nombre d'occurrences
        const sorted = Object.entries(exerciseCount)
            .sort((a, b) => b[1].count - a[1].count)
            .slice(0, 5);

        if (sorted.length === 0) {
            container.innerHTML =
                '<div class="empty-state">Pas encore de donn√©es.</div>';
            return;
        }

        container.innerHTML = sorted
            .map(([name, data], index) => {
                let rankClass = "rank-other";
                let icon = "üèÖ";
                if (index === 0) {
                    rankClass = "rank-1";
                    icon = "ü•á";
                }
                if (index === 1) {
                    rankClass = "rank-2";
                    icon = "ü•à";
                }
                if (index === 2) {
                    rankClass = "rank-3";
                    icon = "ü•â";
                }

                return `
            <div class="top-item">
                <div class="top-rank ${rankClass}">${icon}</div>
                <div class="top-info">
                    <div class="top-name">${name}</div>
                    <div class="top-stats">
                        <span class="highlight">${data.totalValue}</span> ${data.unit} <span class="sep">‚Ä¢</span> <span class="highlight">${data.count}</span> sessions
                    </div>
                </div>
            </div>
        `;
            })
            .join("");
    }

    // @ts-ignore
    function displayHistory(history) {
        const container = document.getElementById("historyList");
        if (!container) return;

        if (history.length === 0) {
            container.innerHTML =
                '<div class="empty-state">Aucun entra√Ænement pour le moment. Commence d√®s maintenant ! üí™</div>';
            return;
        }

        container.innerHTML = history
            .slice(0, 20)
            .map((entry) => {
                const date = new Date(entry.date);
                const formattedDate = date.toLocaleDateString("fr-FR", {
                    day: "numeric",
                    month: "short",
                    hour: "2-digit",
                    minute: "2-digit",
                });

                // Trouver le type pour la couleur
                const card = CARDS_DATABASE.find((c) => c.name === entry.name);
                const type = card ? card.type : "STR"; // Default to STR if not found
                let typeColor = "var(--str)";
                if (type === "AGI") typeColor = "var(--agi)";
                if (type === "DEF") typeColor = "var(--def)";

                return `
                <div class="history-item" style="border-left: 3px solid ${typeColor}">
                    <div class="history-main">
                        <div class="history-name">${entry.name}</div>
                        <div class="history-value">${entry.value} <span class="unit">${entry.unit}</span></div>
                    </div>
                    <div class="history-meta">
                        <span class="history-date"><i data-lucide="clock" style="width:12px; display:inline-block"></i> ${formattedDate}</span>
                        <span class="history-calories">üî• ${entry.calories || 0} kcal</span>
                    </div>
                </div>
            `;
            })
            .join("");

        if (window["lucide"]) window["lucide"].createIcons();
    }
</script>

<style is:global>
    :root {
        --glass-bg: rgba(30, 30, 36, 0.7);
        --glass-border: rgba(255, 255, 255, 0.08);
        --card-bg: linear-gradient(
            145deg,
            rgba(255, 255, 255, 0.05) 0%,
            rgba(255, 255, 255, 0.02) 100%
        );
        --str: #ef4444;
        --agi: #3b82f6;
        --def: #10b981;
    }

    .stats-container {
        min-height: 100vh;
        background: radial-gradient(
            circle at top center,
            #2a2a35 0%,
            #121212 100%
        );
        color: white;
        padding-bottom: 80px;
    }

    .header {
        padding: 20px;
        background: rgba(18, 18, 18, 0.8);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 50;
        border-bottom: 1px solid var(--glass-border);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }
    .header-title {
        font-family: "Rajdhani", sans-serif;
        font-weight: 800;
        font-size: 1.5rem;
        letter-spacing: 2px;
        background: linear-gradient(to right, #fff, #aaa);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
    }
    .btn-back {
        color: #aaa;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        transition: color 0.2s;
    }
    .btn-back:hover {
        color: white;
    }
    .spacer {
        width: 80px;
    }

    .stats-content {
        max-width: 800px;
        margin: 0 auto;
        padding: 25px 20px;
        animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* CARTES R√âSUM√â */
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 15px;
        margin-bottom: 35px;
    }
    .stat-card {
        background: var(--card-bg);
        border: 1px solid var(--glass-border);
        border-radius: 16px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    .stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(
            90deg,
            transparent,
            rgba(255, 255, 255, 0.2),
            transparent
        );
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        border-color: rgba(255, 255, 255, 0.2);
    }
    .stat-icon {
        color: var(--accent);
        width: 28px;
        height: 28px;
        margin-bottom: 12px;
        filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.3));
    }
    .stat-value {
        font-family: "Rajdhani", sans-serif;
        font-size: 2.2rem;
        font-weight: 800;
        color: #fff;
        margin-bottom: 4px;
        line-height: 1;
    }
    .stat-label {
        font-size: 0.8rem;
        color: #94a3b8;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .section-title {
        font-family: "Rajdhani", sans-serif;
        font-size: 1.4rem;
        font-weight: 700;
        margin: 0 0 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        color: #fff;
    }
    .section-title::after {
        content: "";
        flex: 1;
        height: 1px;
        background: linear-gradient(90deg, var(--glass-border), transparent);
    }

    /* GRAPHIQUE */
    .chart-section {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        padding: 25px;
        margin-bottom: 35px;
        box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.2);
    }
    .chart-container {
        width: 100%;
        height: 220px;
    }
    #caloriesChart {
        width: 100%;
        height: 100%;
    }

    /* TOP EXERCICES */
    .top-section {
        margin-bottom: 35px;
    }
    .top-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .top-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px 20px;
        background: var(--card-bg);
        border-radius: 12px;
        border: 1px solid var(--glass-border);
        transition: transform 0.2s;
    }
    .top-item:hover {
        background: rgba(255, 255, 255, 0.08);
        transform: translateX(5px);
    }
    .top-rank {
        font-size: 1.5rem;
        width: 40px;
        text-align: center;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }
    .top-info {
        flex: 1;
    }
    .top-name {
        font-weight: 700;
        font-size: 1.1rem;
        margin-bottom: 4px;
        color: #fff;
    }
    .top-stats {
        font-size: 0.85rem;
        color: #94a3b8;
    }
    .highlight {
        color: var(--accent);
        font-weight: 600;
        font-family: "Rajdhani";
    }
    .sep {
        color: #475569;
        margin: 0 5px;
    }

    /* HISTORIQUE */
    .history-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .history-item {
        background: rgba(30, 30, 36, 0.6);
        border: 1px solid var(--glass-border);
        border-radius: 10px;
        padding: 15px 20px;
        transition: background 0.2s;
        position: relative;
        overflow: hidden;
    }
    .history-item:hover {
        background: rgba(40, 40, 48, 0.8);
    }
    .history-main {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
    }
    .history-name {
        font-weight: 700;
        font-size: 1.05rem;
        color: #e2e8f0;
    }
    .history-value {
        font-family: "Rajdhani", sans-serif;
        font-weight: 700;
        font-size: 1.2rem;
        color: #fff;
    }
    .history-value .unit {
        font-size: 0.8rem;
        color: #94a3b8;
        font-weight: 500;
    }
    .history-meta {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: #64748b;
        font-weight: 500;
    }
    .history-calories {
        color: #f59e0b;
        font-weight: 600;
    }
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #64748b;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 12px;
        border: 2px dashed rgba(255, 255, 255, 0.05);
    }

    /* MOBILE */
    @media (max-width: 640px) {
        .summary-cards {
            grid-template-columns: repeat(2, 1fr);
        }
        .stat-value {
            font-size: 1.8rem;
        }
        .stats-content {
            padding: 15px;
        }
        .chart-container {
            height: 180px;
        }
    }
</style>
