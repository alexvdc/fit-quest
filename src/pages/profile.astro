---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Profil">
    <div class="profile-page">
        <header class="header">
            <a href="/" class="btn-back">
                <i data-lucide="arrow-left"></i> Menu</a>
            <div class="header-title">PROFIL JOUEUR</div>
        </header>

        <div class="scroll-content">
            <!-- SECTION 0 : DONNÃ‰ES PHYSIQUES -->
            <section class="user-data-section">
                <div class="data-row">
                    <div class="input-group">
                        <label>POIDS (KG)</label>
                        <input type="number" id="userWeight" placeholder="75" />
                    </div>
                    <div class="input-group">
                        <label>TAILLE (CM)</label>
                        <input type="number" id="userHeight" placeholder="175" />
                    </div>
                </div>
                <div class="imc-display">
                    IMC: <span id="imcValue">--</span> 
                    <span id="imcLabel" class="imc-tag">Calcul...</span>
                </div>
            </section>

            <!-- SECTION 1 : STATS GLOBALES -->
            <section class="stats-grid">
                <div class="stat-card">
                    <div class="stat-val" id="totalSessions">0</div>
                    <div class="stat-label">SÃ‰ANCES</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val gold" id="totalCalories">0</div>
                    <div class="stat-label">KCAL BRÃ›LÃ‰ES</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val success" id="totalReps">0</div>
                    <div class="stat-label">REPS TOTAL</div>
                </div>
            </section>

            <!-- SECTION 2 : PROGRESSION -->
            <section class="player-stats-card">
                <div class="level-circle">
                    <span class="lvl-label">NIV</span>
                    <span id="playerLevel" class="lvl-num">1</span>
                </div>
                <div class="xp-container">
                    <div class="xp-info">
                        <span>PROGRESSION</span>
                        <span id="xpText" class="xp-text">0 / 100 XP</span>
                    </div>
                    <div class="xp-bar-bg">
                        <div id="xpFill" class="xp-bar-fill" style="width: 0%"></div>
                    </div>
                    <div class="next-reward">
                        Prochain niveau : <span id="nextUnlock">...</span>
                    </div>
                </div>
            </section>

            <!-- SECTION 2.5 : BOUTON TROPHÃ‰ES (MODIFIÃ‰) -->
            <section class="trophy-link-section">
                <a href="/trophies" class="trophy-btn">
                    <div class="icon-zone"><i data-lucide="trophy"></i></div>
                    <div class="text-zone">
                        <div class="btn-title">SALLE DES TROPHÃ‰ES</div>
                        <div class="btn-desc">Voir mes succÃ¨s et rÃ©compenses</div>
                    </div>
                    <i data-lucide="chevron-right"></i>
                </a>
            </section>

            <!-- SECTION 3 : HISTORIQUE RÃ‰CENT -->
            <section class="history-section">
                <h2 class="section-title">HISTORIQUE RÃ‰CENT</h2>
                <div id="historyList" class="history-list">
                    <div class="empty-msg">Aucune activitÃ© rÃ©cente.</div>
                </div>
            </section>

            <!-- SECTION 4 : GESTION DU DECK -->
            <section class="deck-section">
                <div class="section-header">
                    <h2>MON DECK ACTIF</h2>
                    <span class="deck-count"><span id="activeCount">0</span> CARTES</span>
                </div>
                <p class="section-desc">Cochez les exercices pour les activer. Les calories estimÃ©es dÃ©pendent de votre poids et du niveau de la carte.</p>
                <div id="cardsGrid" class="cards-list"></div>
            </section>
        </div>
    </div>
</Layout>

<script>
    import { getSave, saveGame, getGlobalStats } from '../scripts/store.js';
    import { CARDS_DATABASE, CARD_TYPES, LEVEL_CURVE } from '../data/fitquest.js';

    // On retire la logique des achievements d'ici car elle est dans sa propre page maintenant

    document.addEventListener('astro:page-load', () => {
        let state = getSave();
        
        if (!state.history) { state.history = []; saveGame(state); }
        if (!state.userData) { state.userData = { weight: 75, height: 175 }; saveGame(state); }

        // --- GESTION POIDS & TAILLE ---
        const weightInput = document.getElementById('userWeight');
        const heightInput = document.getElementById('userHeight');
        
        if(weightInput && heightInput) {
            // @ts-ignore
            weightInput.value = state.userData.weight || 75;
            // @ts-ignore
            heightInput.value = state.userData.height || 175;

            const updateUserData = () => {
                // @ts-ignore
                const w = parseFloat(weightInput.value);
                // @ts-ignore
                const h = parseFloat(heightInput.value);
                
                if(w > 0 && h > 0) {
                    state.userData.weight = w;
                    state.userData.height = h;
                    saveGame(state);
                    renderDeck(state); // Update Calories
                    renderIMC(w, h);   // Update IMC
                }
            };

            weightInput.onchange = updateUserData;
            heightInput.onchange = updateUserData;
            
            // Calcul initial IMC
            renderIMC(state.userData.weight, state.userData.height);
        }

        renderGlobalStats(state);
        renderHistory(state);
        renderStats(state);
        renderDeck(state);
    });

    function renderIMC(weight, height) {
        const imcVal = document.getElementById('imcValue');
        const imcLabel = document.getElementById('imcLabel');
        if(!imcVal || !imcLabel) return;

        const hMeters = height / 100;
        const imc = weight / (hMeters * hMeters);
        
        imcVal.innerText = imc.toFixed(1);
        
        let label = "";
        let color = "#888";
        
        if(imc < 18.5) { label = "Poids plume"; color = "#3b82f6"; } 
        else if(imc < 25) { label = "Ã‰quilibrÃ©"; color = "#10b981"; } 
        else if(imc < 30) { label = "Costaud"; color = "#fbbf24"; } 
        else { label = "Titan"; color = "#f43f5e"; } 
        
        imcLabel.innerText = label;
        imcLabel.style.color = color;
        imcLabel.style.borderColor = color;
    }

    function renderGlobalStats(state) {
        const stats = getGlobalStats(state);
        const sessEl = document.getElementById('totalSessions');
        const repsEl = document.getElementById('totalReps');
        const calEl = document.getElementById('totalCalories');

        if(sessEl) sessEl.innerText = stats.totalSessions;
        if(repsEl) repsEl.innerText = stats.totalReps;
        if(calEl) calEl.innerText = stats.totalCalories;
    }

    function renderHistory(state) {
        const list = document.getElementById('historyList');
        if(!list) return;
        const history = state.history || [];
        if(history.length === 0) return; 

        list.innerHTML = '';
        
        history.slice(0, 10).forEach(h => {
            const date = new Date(h.date);
            const dateStr = date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
            const timeStr = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            const calories = h.calories ? `<span class="h-cal">ðŸ”¥ ${h.calories} kcal</span>` : '';

            const item = document.createElement('div');
            item.className = 'history-item';
            item.innerHTML = `
                <div class="h-date">
                    <span class="d-day">${dateStr}</span>
                    <span class="d-time">${timeStr}</span>
                </div>
                <div class="h-info">
                    <div class="h-name">${h.name}</div>
                    <div class="h-val">${h.value} ${h.unit}</div>
                </div>
                <div class="h-right">
                    ${calories}
                    <div class="h-xp">+${h.xp} XP</div>
                </div>
            `;
            list.appendChild(item);
        });
    }

    function renderStats(state) {
        const currentLvl = state.playerLevel || 1;
        const currentXp = state.playerXp || 0;
        const nextLevelXp = (LEVEL_CURVE && LEVEL_CURVE[currentLvl]) ? LEVEL_CURVE[currentLvl] : 9999;
        const pct = Math.min(100, (currentXp / nextLevelXp) * 100);

        const lvlEl = document.getElementById('playerLevel');
        const xpText = document.getElementById('xpText');
        const xpFill = document.getElementById('xpFill');
        const nextUnlock = document.getElementById('nextUnlock');

        if(lvlEl) lvlEl.innerText = currentLvl;
        if(xpText) xpText.innerText = `${Math.floor(currentXp)} / ${nextLevelXp} XP`;
        if(xpFill) xpFill.style.width = `${pct}%`;

        const nextCard = CARDS_DATABASE.find(c => c.unlockLevel > currentLvl);
        if(nextUnlock) nextUnlock.innerText = nextCard ? `DÃ©bloque "${nextCard.name}"` : "Niveau Max !";
    }

    function renderDeck(state) {
        const grid = document.getElementById('cardsGrid');
        const countEl = document.getElementById('activeCount');
        if(!grid) return;

        grid.innerHTML = '';
        const unlocked = state.unlockedCards || [];
        const active = state.activeDeck || [];
        const weight = state.userData?.weight || 75;
        
        let activeCount = 0;

        CARDS_DATABASE.forEach(card => {
            const isUnlocked = unlocked.includes(card.id);
            const isActive = active.includes(card.id);
            const typeInfo = CARD_TYPES[card.type];

            if(isActive) activeCount++;

            let estCalories = 0;
            if (isUnlocked) {
                const lvl = (state.cardLevels && state.cardLevels[card.id]) || 1;
                const cost = card.baseCost + (lvl - 1) * card.costScale;
                let durationMin = 0;
                if (card.unit === 'Sec') {
                    durationMin = cost / 60;
                } else {
                    durationMin = (cost * 3) / 60;
                }
                const met = card.met || 4.0;
                estCalories = Math.round((met * 3.5 * weight) / 200 * durationMin);
                if(estCalories < 1) estCalories = 1;
            }

            const el = document.createElement('div');
            el.className = `deck-item ${isUnlocked ? '' : 'locked'} ${isActive ? 'active' : ''}`;
            
            el.innerHTML = `
                <div class="item-icon" style="color:${typeInfo.color}"><i data-lucide="${typeInfo.icon}"></i></div>
                <div class="item-info">
                    <div class="item-header">
                        <div class="item-name">${card.name}</div>
                        ${isUnlocked ? `<div class="item-cal">ðŸ”¥ ~${estCalories} kcal</div>` : ''}
                    </div>
                    <div class="item-desc">${isUnlocked ? typeInfo.label : `DÃ©bloquÃ© au niv ${card.unlockLevel}`}</div>
                </div>
                <div class="item-action">
                    ${isUnlocked ? `<div class="toggle-switch"><input type="checkbox" ${isActive ? 'checked' : ''} /><span class="slider"></span></div>` : `<i data-lucide="lock" size="16"></i>`}
                </div>
            `;

            if (isUnlocked) {
                const toggle = el.querySelector('input');
                const slider = el.querySelector('.slider');
                if (slider && toggle) {
                    slider.onclick = (e) => {
                        e.stopPropagation();
                        const newState = !toggle.checked;
                        toggle.checked = newState;
                        toggleCard(state, card.id, newState);
                    };
                }
            }
            grid.appendChild(el);
        });

        if(countEl) countEl.innerText = activeCount;
        if(window['lucide']) window['lucide'].createIcons();
    }

    function toggleCard(state, cardId, shouldBeActive) {
        if (!Array.isArray(state.activeDeck)) state.activeDeck = [];
        if (shouldBeActive) {
            if (!state.activeDeck.includes(cardId)) state.activeDeck.push(cardId);
        } else {
            if (state.activeDeck.length <= 3) {
                alert("Il faut au moins 3 cartes actives !");
                renderDeck(state); 
                return;
            }
            state.activeDeck = state.activeDeck.filter(id => id !== cardId);
        }
        saveGame(state);
        renderDeck(state);
    }
</script>

<style is:global>
    .profile-page { height: 100vh; display: flex; flex-direction: column; background: radial-gradient(circle at top, #1a1a2e, #000); }
    .header { padding: 20px; background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); z-index: 10; }
    .header-title { font-family: 'Rajdhani'; font-weight: 800; font-size: 1.2rem; letter-spacing: 2px; color:white; }
    .scroll-content { flex: 1; overflow-y: auto; padding: 20px; max-width: 600px; margin: 0 auto; width: 100%; }

    /* USER DATA FORM */
    .user-data-section { 
        background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 20px; 
        border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; gap: 10px;
    }
    .data-row { display: flex; justify-content: space-between; width: 100%; gap: 15px; }
    .input-group { display: flex; align-items: center; gap: 10px; flex: 1; }
    .input-group label { font-family: 'Rajdhani'; font-weight: 700; color: var(--accent); font-size: 0.9rem; white-space: nowrap; }
    .input-group input { 
        background: #111; border: 1px solid #444; color: white; padding: 8px; border-radius: 6px; 
        width: 100%; font-family: 'Rajdhani'; font-size: 1.1rem; font-weight: bold; text-align: center; 
    }
    
    .imc-display {
        display: flex; justify-content: space-between; align-items: center; width: 100%;
        font-family: 'Rajdhani'; color: #888; font-weight: 700; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 10px;
    }
    #imcValue { color: white; font-size: 1.2rem; margin-left: 5px; }
    .imc-tag { font-size: 0.8rem; padding: 2px 8px; border: 1px solid; border-radius: 4px; text-transform: uppercase; }

    /* STATS GRID */
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .stat-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 15px 5px; text-align: center; }
    .stat-val { font-family: 'Rajdhani'; font-weight: 800; font-size: 1.5rem; line-height: 1; color: white; margin-bottom: 5px; }
    .stat-val.success { color: var(--success); }
    .stat-val.gold { color: #fbbf24; }
    .stat-label { font-size: 0.6rem; color: #888; font-weight: 700; letter-spacing: 1px; }

    /* PLAYER CARD */
    .player-stats-card { background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01)); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 20px; display: flex; gap: 20px; align-items: center; margin-bottom: 30px; }
    .level-circle { width: 60px; height: 60px; border-radius: 50%; border: 3px solid var(--accent); display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(139, 92, 246, 0.1); box-shadow: 0 0 20px rgba(139, 92, 246, 0.2); }
    .lvl-label { font-size: 0.6rem; font-weight: 700; color: var(--accent); }
    .lvl-num { font-size: 1.6rem; font-weight: 900; line-height: 1; color: white; font-family: 'Rajdhani'; }
    .xp-container { flex: 1; }
    .xp-info { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 5px; color: #aaa; font-family: 'Rajdhani'; font-weight: 700; }
    .xp-bar-bg { height: 8px; background: rgba(0,0,0,0.5); border-radius: 5px; overflow: hidden; margin-bottom: 8px; }
    .xp-bar-fill { height: 100%; background: var(--accent); box-shadow: 0 0 10px var(--accent); transition: width 0.5s ease; }
    .next-reward { font-size: 0.75rem; color: #666; font-style: italic; }

    /* TROPHY LINK BUTTON */
    .trophy-link-section { margin-bottom: 30px; }
    .trophy-btn { 
        display: flex; align-items: center; gap: 15px; padding: 20px;
        background: linear-gradient(90deg, rgba(251, 191, 36, 0.1), rgba(0,0,0,0));
        border: 1px solid var(--gold); border-radius: 16px;
        color: white; text-decoration: none; transition: 0.2s;
    }
    .trophy-btn:hover { transform: translateY(-2px); background: linear-gradient(90deg, rgba(251, 191, 36, 0.2), rgba(0,0,0,0)); }
    .icon-zone { 
        width: 50px; height: 50px; background: rgba(251, 191, 36, 0.2); 
        border-radius: 50%; display: flex; justify-content: center; align-items: center; color: var(--gold);
    }
    .text-zone { flex: 1; }
    .btn-title { font-family: 'Rajdhani'; font-weight: 800; font-size: 1.1rem; color: var(--gold); }
    .btn-desc { font-size: 0.8rem; color: #aaa; }

    /* HISTORY SECTION */
    .history-section { margin-bottom: 30px; }
    .section-title { font-family: 'Rajdhani'; font-weight: 800; font-size: 1.2rem; color: white; margin: 0 0 15px 0; border-bottom: 1px solid #333; padding-bottom: 5px; }
    .history-list { display: flex; flex-direction: column; gap: 8px; }
    .history-item { background: rgba(20, 20, 23, 0.6); border: 1px solid rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; }
    .h-date { display: flex; flex-direction: column; font-size: 0.7rem; color: #666; min-width: 50px; }
    .d-day { font-weight: bold; color: #888; }
    .h-info { flex: 1; padding: 0 15px; }
    .h-name { color: white; font-weight: 600; font-size: 0.95rem; }
    .h-val { color: var(--success); font-family: 'Rajdhani'; font-weight: 700; font-size: 0.9rem; }
    .h-right { text-align: right; }
    .h-cal { display: block; font-size: 0.7rem; color: #f97316; margin-bottom: 2px; font-weight: bold; }
    .h-xp { font-family: 'Rajdhani'; font-weight: 700; color: var(--accent); font-size: 0.9rem; }
    .empty-msg { color: #666; font-style: italic; text-align: center; padding: 10px; }

    /* DECK SECTION */
    .section-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 10px; }
    h2 { font-family: 'Rajdhani'; font-weight: 800; font-size: 1.5rem; color: white; margin: 0; }
    .deck-count { font-family: 'Rajdhani'; color: var(--success); font-weight: bold; }
    .section-desc { font-size: 0.8rem; color: #888; margin-bottom: 20px; }
    .cards-list { display: flex; flex-direction: column; gap: 10px; padding-bottom: 50px; }
    .deck-item { display: flex; align-items: center; gap: 15px; background: rgba(20, 20, 23, 0.6); border: 1px solid rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; transition: 0.2s; }
    .deck-item.active { border-color: rgba(139, 92, 246, 0.4); background: rgba(139, 92, 246, 0.05); }
    .deck-item.locked { opacity: 0.5; filter: grayscale(1); pointer-events: none; }
    .item-icon { width: 40px; height: 40px; background: rgba(0,0,0,0.3); border-radius: 8px; display: flex; justify-content: center; align-items: center; }
    .item-info { flex: 1; }
    .item-header { display: flex; justify-content: space-between; align-items: baseline; }
    .item-name { font-weight: 700; color: white; font-family: 'Rajdhani'; font-size: 1.1rem; }
    .item-cal { font-size: 0.7rem; color: #f97316; font-weight: bold; margin-left: 10px; }
    .item-desc { font-size: 0.75rem; color: #777; }
    .toggle-switch { position: relative; width: 50px; height: 26px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; inset: 0; background-color: #333; border-radius: 34px; transition: .4s; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: .4s; }
    input:checked + .slider { background-color: var(--success); }
    input:checked + .slider:before { transform: translateX(24px); }
</style>